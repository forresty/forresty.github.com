
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Cassandra and Ruby - Forrest Ye's Blog</title>
  <meta name="author" content="Forrest Ye">

  
  <meta name="description" content="I&#8217;ve been working on a project that requires the usage of Cassandra and Ruby for some time already, and the process is at the same time quite &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://forresty.com/blog/2012/10/18/cassandra-and-ruby/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Forrest Ye's Blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-12985731-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Forrest Ye's Blog</a></h1>
  
    <h2>Patiently waiting for the dots to connect themselves</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:forresty.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Cassandra and Ruby</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-10-18T11:36:00+08:00" pubdate data-updated="true">Oct 18<span>th</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>I&#8217;ve been working on a project that requires the usage of Cassandra and Ruby for some time already, and the process is at the same time quite painfully slow and rewarding for me.</p>

<!-- more -->


<p>To be honest, working with Cassandra using Ruby is not a pleasant experience, especially for a not-so-experienced programmer like me. IMHO the main problems are:</p>

<ol>
<li><p>Cassandra itself, is not so wonderful as promised. Sitting on the AP side of the CAP theorem, that is, unlike traditional RDBMSs or newer NoSQL breeds such as MongoDB and Redis, Cassandra is always available and partitioning-tolerant, while sacrificing consistency. Being open-sourced by Facebook and later adopted by Twitter and Reddit etc, it solves very specific problems for them: inbox search for Facebook, real-time analytics for Twitter, and persistent cache for Reddit. THEY DON&#8217;T USE IT AS MAIN STORAGE ENGINES AND THERE ARE NOT MANY PEOPLE IN THE WILD USING IT. That alone can tell something.</p></li>
<li><p>Cassandra is not very Ruby-friendly, or better put, there is not a huge community of Ruby users playing with it, perhaps due to somewhat conflicts in philosophy? Unlike widely available options of open source client libraries for other storage engines, most notably ActiveRecord from Rails for traditional RDBMS, or Mongoid for MongoDB, there are only low-level libraries such as thrift_client gem and cassandra gem by Twitter, the only good high-level library I can find is data-axle&#8217;s fork of cassandra_object, which only has 28 watchers on GitHub. So in that sense, I do feel lonely a little bit, good thing is I&#8217;ve already gotten used to that.</p></li>
</ol>


<p>Well, this is not a post about the downside of using Cassandra with Ruby, so I&#8217;d just stop the complaint. If I am really as good at coding and hacking as I imagined myself to be, I would be much happier. So I only have myself to blame.</p>

<p>So back to the main topic.</p>

<p>Thrift interface is Cassandra&#8217;s lowest level API interface, it&#8217;s quite like the ProtocolBuffer from Google or the (seemingly more sassy) MessagePack. Though CQL is later added as an interface option, the CQL channel is actually built upon thrift interface - that is, every time you execute a CQL query against a Cassandra node, your query is packaged as a Thrift RPC call to that node, and you get your results back as a packet of binary thrift formatted data. Performance-wise, various people have done experiments and the difference between raw thrift calls and cql queries is not apparent, which is quite understandable. Besides Thrift, there used to be an alternative RPC interface based on Avro which is a bit similar to Thrift, the reasons why it was introduced in the first place and why later got dropped I never bother myself to look into.</p>

<p>Since Cassandra is written in Java, so naturally its Thrift server is implemented in Java. So typically when you use Cassandra with Ruby, you are going down on this route:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cassandra gem (from Twitter, in Ruby) ---&gt;
</span><span class='line'>thrift_client gem (Twitter, simply a wrapper around thrift gem, Ruby) ---&gt;
</span><span class='line'>thrift gem (from the Thrift team, part of Thrift source code, Ruby & C) ---&gt;
</span><span class='line'>[TCP/IP or Unix socket, possibly over the inter-webz] ---&gt;
</span><span class='line'>Thrift server (from the Cassandra team, in Java) ---&gt;
</span><span class='line'>Cassandra internal API (Cassandra, Java) ---&gt;
</span><span class='line'>Cassandra (hooray!)</span></code></pre></td></tr></table></div></figure>


<p>Well, what I am doing (and a bunch of other people) is throwing on top of these another layer, the data-axle&#8217;s fork of cassandra_object, which is modeled based on the awesome ActiveModel project introduced in Rails 3 and uses the cassandra gem from Twitter internally, and then trying to tame it to my specific needs, and hack yet another layer of business logic on top of it. So you can imagine when things went wrong, I&#8217;d be forced to go down each layer trying to figure out what the fuck is going on. Since there is no a huge community, I am thankful that my hair is short so I don&#8217;t have the risks of getting them pulled off by the irritated me.</p>

<p>But it&#8217;s quite fun and so far I am still enjoying it. I see myself forking the top most layers, learning the hell out of every bit of technical details, and hopefully I don&#8217;t need to go down to the very bottom. During the whole process I am often overwhelmed by a mixed feeling: the hatred towards myself and the regret that I didn&#8217;t become a hard-core tech nerd as early as when I am still in college, and the joy of challenging myself to understand every piece of details down the road and finally getting close to it.</p>

<p>Let see how far it goes.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Forrest Ye</span></span>

      








  


<time datetime="2012-10-18T11:36:00+08:00" pubdate data-updated="true">Oct 18<span>th</span>, 2012</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://forresty.com/blog/2012/10/18/cassandra-and-ruby/" data-via="forresty" data-counturl="http://forresty.com/blog/2012/10/18/cassandra-and-ruby/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/10/15/smoking-and-quitting/" title="Previous Post: smoking and quitting">&laquo; smoking and quitting</a>
      
      
        <a class="basic-alignment right" href="/blog/2012/10/22/rainy-day/" title="Next Post: rainy day">rainy day &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/10/22/rainy-day/">rainy day</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/18/cassandra-and-ruby/">Cassandra and Ruby</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/15/smoking-and-quitting/">smoking and quitting</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/08/18/yukio-mishima/">三岛由纪夫</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/08/11/cassandra-notes-part-1/">Notes and Quotes of Cassandra The Definitive Guide, Part-1: Introduction</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("forresty", 5, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/forresty" class="twitter-follow-button" data-show-count="false">Follow @forresty</a>
  
</section>


<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/forresty">@forresty</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'forresty',
            count: 10,
            skip_forks: false,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <img src="http://projecteuler.net/profile/forresty.png" alt="project euler status" />
</section>
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Forrest Ye -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
